{% extends 'base.html.twig' %}

{% block title %}{{ article.titre }}{% endblock %}

{% block body %}
<h1>{{ article.titre }}</h1>

{# Vérifie si une image est associée à l'article et l'affiche #}
{% if article.image %}
    <div>
        <img src="{{ asset('uploads/images/' ~ article.image) }}" alt="Image de l'article" style="max-width: 500px; height: auto;">
    </div>
{% else %}
    <p><em>Aucune image disponible.</em></p>
{% endif %}

<p><strong>Contenu :</strong></p>
<p>{{ article.content }}</p>

{% if article.categories is not empty %}
    <p><strong>Catégories :</strong></p>
    <ul>
        {% for categorie in article.categories %}
            <li>{{ categorie.nom }}</li>
        {% endfor %}
    </ul>
{% else %}
    <p><em>Aucune catégorie associée.</em></p>
{% endif %}

<h2>Commentaires</h2>

{% for commentaire in article.commentaires %}
    <div>
        <p>
            <strong>{{ commentaire.auteur.username }} :</strong> {{ commentaire.contenu }}<br>
            <small>Posté le {{ commentaire.createdAt|date('d/m/Y H:i') }}</small>
        </p>

        {% if app.user == commentaire.auteur or is_granted('ROLE_ADMIN') %}
            <a href="{{ path('comment_edit', { id: commentaire.id }) }}">Modifier</a>
            <form method="post" action="{{ path('comment_delete', { id: commentaire.id }) }}" style="display:inline;">
                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ commentaire.id) }}">
                <button type="submit">Supprimer</button>
            </form>
        {% endif %}
    </div>
    <hr>
{% endfor %}

{% if is_granted('IS_AUTHENTICATED_FULLY') %}
    <h3>Ajouter un commentaire</h3>
    <form method="post" action="{{ path('comment_new', { id: article.id }) }}">
        <textarea name="contenu" required placeholder="Votre commentaire"></textarea>
        <button type="submit">Envoyer</button>
    </form>
{% else %}
    <p><a href="{{ path('app_login') }}">Connectez-vous</a> pour ajouter un commentaire.</p>
{% endif %}


<a href="{{ path('article_index') }}">Retour à la liste des articles</a>

{# Vérifie si l'utilisateur est admin ou l'auteur de l'article #}
{% if is_granted('ROLE_ADMIN') or app.user == article.user %}
    <a href="{{ path('article_edit', { id: article.id }) }}">Modifier cet article</a>
    <form method="post" action="{{ path('article_delete', { id: article.id }) }}" style="display: inline;" onsubmit="return confirm('Voulez-vous vraiment supprimer cet article ?');">
        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ article.id) }}">
        <button type="submit" class="btn btn-danger">Supprimer</button>
    </form>
{% endif %}
{% endblock %}
